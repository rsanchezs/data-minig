---
title: "Mineria de dades: PEC3 Classificació arbres de decissió"
author: "Autor: Nom estudiant"
date: "Octubre 2018"
output:
  word_document: default
  pdf_document:
    highlight: zenburn
    toc: yes
  html_document:
    highlight: default
    number_sections: yes
    theme: cosmo
    toc: yes
    toc_depth: 2
    includes:
      in_header: 75.584-PAC-header.html
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(eval=T, echo=T)
```
******
# Introducció
******
## Presentació
Aquesta Prova d'Avaluació Continuada cobreix els mòduls 3 i 8 (Avaluació de Models) del programa de l'assignatura

## Competències
Les competències que es treballen en aquesta prova són:

* Ús i aplicació de les TIC en l'àmbit acadèmic i professional
* Capacitat per  innovar i generar noves idees.
* Capacitat per avaluar solucions tecnològiques i elaborar propostes de projectes tenint en compte els recursos, les alternatives disponibles i les condicions de mercat.
* Conèixer les tecnologies de comunicacions actuals i emergents i saber-les aplicar convenientment per a dissenyar i desenvolupar solucions basades en sistemes i tecnologies de la informació.
* Aplicació de les tècniques específiques d'enginyeria del programari a les diferents etapes del cicle de vida d'un projecte.
* Capacitat per aplicar les tècniques específiques de tractament, emmagatzematge i administració de dades.
* Capacitat per proposar i avaluar diferents alternatives tecnològiques per a resoldre un problema concret.

## Objectius
La correcta assimilació del Mòdul 3:
En aquesta PAC treballarem la generació, interpretació i avaluació d'un arbre de decisió amb el programari de pràctiques. Seguirem també treballant amb la preparació de les dades i extracció inicial de coneixement


## Descripció de la PAC a realitzar
La prova està estructurada en un total de 1 exercici teòric i 1 exercicis teòric/pràctic. Aquests exercicis estan tots relacionats. És necessari fer-los tots per a obtenir una valoració satisfactòria.

##Recursos

**Bàsics**

Material docent proporcionat por la UOC.

**Complementaris**

En el wiki del aula trobareu:

*	Els descrits en l'anterior PAC
*	Fitxer titanic.csv
*	https://cran.r-project.org/web/packages/C50/index.html

## Criteris de valoració

**Exercicis teòrics**

Tots els exercicis han de ser presentats de forma raonada i clara, especificant tots i cadascun dels passos que s'hagin dut a terme per a la seva resolució. No s'acceptarà cap resposta que no estigui clarament justificada.

**Exercicis pràctics**

Per a totes les PAC és necessari documentar en cada apartat de l'exercici pràctic què s'ha fet i com s'ha fet, quin era l'objectiu i com s'ha desenvolupat.

##Format i data d'entrega

El format de lliurament és: usernameestudiant-PACn.html/doc/docx/odt/pdf

Data de lliurament: 07/11/2018

Cal lliurar la PAC a la bústia de lliuraments de l'aula

## Nota: Propietat intelectual

> Sovint és inevitable, al produir una obra multimèdia, fer ús de recursos creats per terceres persones. És per tant comprensible fer-lo en el marc d'una pràctica dels Estudis, sempre que això es documenti clarament i no suposi plagi en la pràctica.

> Per tant, al presentar una pràctica que faci ús de recursos aliens, s'ha de presentar juntament amb ella un document en quin es detallin tots ells, especificant el nom de cada recurs, el seu autor, el lloc on es va obtenir i el seu estatus legal: si l'obra està protegida pel copyright o s'acull a alguna altra llicència d'ús (Creative Commons, llicència GNU, GPL ...).

> L'estudiant haurà d'assegurar-se que la llicència no impedeix específicament el seu ús en el marc de la pràctica. En cas de no trobar la informació corresponent haurà d'assumir que l'obra està protegida per copyright.
Hauríeu de, a més, adjuntar els fitxers originals quan les obres utilitzades siguin digitals, i el seu codi font si correspon


******
# Enunciat  
******


En aquest exercici anem a seguir els passos del cicle de vida d'un projecte de mineria de dades, cortesia d'una companya d'un semestre anterior, per al cas d'un algorisme de classificació i més concretament un arbre de decisió. Ho farem amb l'arxiu titanic.csv, que es troba adjunt a l'aula. Aquest arxiu conté un registre per cada passatger que viatjava en el Titanic. En les variables es caracteritza si era home o dona, adult o nen, en quina categoria viatjava o si era membre de la tripulació

Objectius:

* Estudiar les dades, per exemple: Nombre de registres del fitxer? Distribucions de valors per variables? Hi ha camps mal informats o buits?
* Preparar les dades. En aquest cas ja estan en el format correcte i no és necessari discretitzar ni generar atributs nous. Cal triar quins són les variables que s'utilitzaran per construir el model i quin és la variable que classifica. En aquest cas la variable per la qual classificarem és el camp de si el passatger va sobreviure o no
* Instal·lar, si és necessari, el paquet C5.0 Es tracta d'una implementació més moderna de l'algorisme ID3 de Quinlan. Té els principis teòrics de ID3  més la poda automàtica. Amb aquest paquet generar un model de mineria.
* Quin és la qualitat del model?
* Generar l'arbre gràfic
* Generar i extreure les regles del model
* En funció del model, l'arbre i les regles: Quin és el coneixement que obtenim?
* Provar el model generat presentant-li nous registres. Classifica suficientment bé?

## Revisió de les dades, extracció visual d'informació i preparació de les dades

Càrrega de les dades

```{r message= FALSE, warning=FALSE}
data<-read.csv("~/titanic.csv",header=T,sep=",")
attach(data)
```


Començarem fent un breu anàlisi de les dades ja que ens interessa tenir una idea general de les dades que disposem. Per això, primer calcularem les dimensions de la nostra base de dades i analitzarem què tipus d'atributs tenim.
Per començar, calculem les dimensions de la base de dades mitjançant la funció dim(). Obtenim que disposem de 2201 registres o passatgers (files) i 4 variables (columnes). Quines són aquestes variables? Gràcies a la funció str() sabem que les quatre variables són categòriques o discretes, és a dir, prenen valors en un conjunt finit. La variable CLASS fa referència a la classe en la qual viatjaven els passatgers (1ª, 2ª, 3ª o crew), AGE determina si era adult o nen (Adult o Nen), la variable 'SEX' si era home o dona (Home o Dona) i l'última variable ('SURVIVED') informa si el passatger va morir o va sobreviure en l'accident (Mor o Sobreviu).

```{r}
dim(data)#2201 observacions (files) i 4 variables (columnes)
str(data)
```
És de gran interès saber si tenim molts valors nuls (camps buits) i la distribució de valors per variables. És per això recomanable començar l'anàlisi amb una visió general de les variables. Mostrarem per cada variable quantitat de valors perduts mitjançant la funció summary.
```{r}
summary(data)
```
Disposem per tant d'un data frame format per quatre variables categòriques sense valors nuls. Per a un coneixement major sobre les dades, tenim al nostre abast unes eines molt valuoses: les eines de visualització. Per a aquestes visualitzacions, farem ús dels paquets ggplot2, gridExtra i grid d'R.
```{r}
if(!require(ggplot2)){
    install.packages('ggplot2', repos='http://cran.us.r-project.org')
    library(ggplot2)
}
if(!require(grid)){
    install.packages('grid', repos='http://cran.us.r-project.org')
    library(grid)
}
if(!require(gridExtra)){
    install.packages('gridExtra', repos='http://cran.us.r-project.org')
    library(gridExtra)
}

```
Ens interessa descriure la relació entre la supervivència i cadascun de les variables esmentades anteriorment. Per a això, d'una banda dibuixarem mitjançant diagrames de barres la quantitat de morts i supervivents segons la classe en la qual viatjaven, l'edat o el sexe. D'altra banda, per obtenir les dades que estem dibuixant farem servir la comanda table per a dues variables que ens proporciona una taula de contingència.
```{r}
grid.newpage()
plotbyClass<-ggplot(data,aes(CLASS,fill=SURVIVED))+geom_bar() +labs(x="Class", y="Passengers")+ guides(fill=guide_legend(title=""))+ scale_fill_manual(values=c("black","#008000"))+ggtitle("Survived by Class")
plotbyAge<-ggplot(data,aes(AGE,fill=SURVIVED))+geom_bar() +labs(x="Age", y="Passengers")+ guides(fill=guide_legend(title=""))+ scale_fill_manual(values=c("black","#008000"))+ggtitle("Survived by Age")
plotbySex<-ggplot(data,aes(SEX,fill=SURVIVED))+geom_bar() +labs(x="Sex", y="Passengers")+ guides(fill=guide_legend(title=""))+ scale_fill_manual(values=c("black","#008000"))+ggtitle("Survived by Sex")
grid.arrange(plotbyClass,plotbyAge,plotbySex,ncol=2)

```

D'aquests gràfics obtenim informació molt valuosa que complementem amb les taules de contingència. D'una banda, la quantitat de passatgers que van sobreviure és similar en homes i dones (si ens fixem en la primera taula de contingència, ho confirmem, homes: 367 i dones 344). No, en canvi, si tenim en compte el percentatge respecte al seu sexe. És a dir, malgrat que la quantitat de dones i homes que van sobreviure és similar, viatjaven més homes que dones (470 dones i 1731 homes), per tant, la taxa de mort en homes és moltíssim major (el 78,79% dels homes van morir mentre que en dones aquest percentatge baixa a 26,8%). Quant a la classe en la qual viatjaven, els passatgers que viatjaven en primera classe van ser els únics que el percentatge de supervivència va ser major que el de mortalitat. El 62,46% dels viatgers de primera classe va sobreviure, el 41,4% dels quals viatjaven en segona classe mentre que dels viatgers de tercera i de la tripulació solament van sobreviure un 25,21% i 23,95% respectivament. Per finalitzar, destaquem que la presència de passatgers adults era molt major que la dels nens (2092 enfront de 109) i que la taxa de supervivència en nens va ser molt major (31,26% enfront de 52,29%), no podem obviar, en canvi, que els únics nens que van morir van ser tots passatgers de tercera classe (52 nens).
```{r}

tabla_SST <- table(SEX,SURVIVED)
tabla_SST
prop.table(tabla_SST)

prop.table(tabla_SST, margin = 1)
```
```{r}
tabla_SCT <- table(CLASS,SURVIVED)
tabla_SCT
prop.table(tabla_SCT,1)
```
```{r}
tabla_SAT <- table(AGE,SURVIVED)
tabla_SAT
prop.table(tabla_SAT, margin = 1) 
```
```{r}
table(data) #els únics nens que varen morir vitajaven en 3ª classe
```
Una alternativa interessant a les barres de diagrames, és el plot de les taules de contingència. Obtenim la mateixa informació però pot ser més visual.
```{r}
par(mfrow=c(2,2))
plot(tabla_SCT, col = c("black","#008000"), main = "SURVIVED vs. CLASS")
plot(tabla_SAT, col = c("black","#008000"), main = "SURVIVED vs. AGE")
plot(tabla_SST, col = c("black","#008000"), main = "SURVIVED vs. SEX")
```
El nostre objectiu és crear un arbre de decisió que permeti analitzar quin tipus de passatger del Titanic tenia probabilitats de sobreviure o no. Per tant, la variable per la qual classificarem és el camp de si el passatger va sobreviure o no. De tota manera, en imprimir les primeres i últimes 10 files ens adonem que les dades estan ordenades, per tant, ens interessarà "desordenar-les". Guardarem les dades amb el nou nom com "data_random".

```{r echo=TRUE, message=TRUE, warning=TRUE}
# head() obtenim, les primeres files del nostre dataframe
head(data,10)
# tail() obtenim les darreres files del nostre dataframe
tail(data,10)
set.seed(666)
#Queremos "desordenar" los datos
data_random <- data[sample(nrow(data)),]
```
Per a la futura avaluació de l'arbre de decisió, voldrem dividir el conjunt de dades en un conjunt d'entrenament i un conjunt de prova. El conjunt d'entrenament és el subconjunt del conjunt original de dades utilitzat per construir un primer model. El conjunt de prova, és el subconjunt del conjunt original de dades utilitzat per avaluar la qualitat del model. El més correcte serà utilitzar un conjunt de dades diferent del que utilitzem per construir l'arbre, és a dir, un conjunt diferent del d'entrenament. No hi ha cap proporció fixada pel que fa al nombre relatiu de components de cada subconjunt, però la més utilitzada acostuma a ser 2/3 per al conjunt d'entrenament i 1/3, per al conjunt de prova.
```{r}
#la variable amb la que classificarem és el camp de si el passatger va sobreviure o no 
#que està a la cuarta columna.
set.seed(666)
y<-data_random[,4] #SURVIVED
X <- data_random[,1:3] #Resta de variables

#Podem triar el subconjunt d'entrenament i de prova de diverses maneres.
#1)Opció: calcular a quantes files correspon dos terços de les dades 22201/3=(1467) i dividir "manualment" el conjunt.


trainX <- X[1:1467,]
trainy <- y[1:1467]
testX <- X[1468:2201,]
testy <- y[1468:2201]


#2)Opció: Directament crear un rang
set.seed(666)
indexes = sample(1:nrow(data), size=floor((2/3)*nrow(data)))
trainX<-X[indexes,]
trainy<-y[indexes]
testX<-X[-indexes,]
testy<-y[-indexes]
```
Després d'una extracció aleatòria de casos és altament recomanable efectuar una anàlisi de dades mínima per assegurar-nos de no obtenir classificadors esbiaixats pels valors que conté cada mostra.


## Creació del model, qualitat del model i extracció de regles
```{r}
#Creació de l'arbre amb les dades d'entrenament
model <- C50::C5.0(trainX, trainy,rules=TRUE )
summary(model)
```
Size és el nombre de fulles no buides en l'arbre i Errors mostra el nombre i percentatge de casos mal classificats en el subconjunt d'entrenament. L'arbre, amb 2 fulles, classifica erròniament 309 dels 1467 casos donats, una taxa d'error del 21.1%.

A partir de l'arbre de decisió de dues fulles que hem modelat, es poden extreure les següents regles de decisió (gràcies a rules=TRUE podem imprimir les regles directament):

SEX = "Home" ??? Mor Validesa: 79,3%

CLASS = "3a" ??? Mor Validesa: 77,9%

CLASS "1ª", "2ª"" o "Crew" i SEX = "Dona" ??? Sobreviu Validesa: 91,9%

Per tant podem concloure que el coneixement extret i creuat amb l'anàlisi visual es resumeix en "les dones i els nens primer a excepció que anessis en 3ª classe"

Podem generar l'arbre.
```{r}
model <- C50::C5.0(trainX, trainy)
plot(model)
```

## Validació del model amb les dades que hem reservat

```{r}
#PREDICCIÓ
#Presentem al model creat les dades guardades per realitzar la predicció i mesurar la precisió de l'arbre
predicted_model <- predict( model, testX, type="class" )
print(sprintf("La precisió de l'arbre és: %.4f %%",100*sum(predicted_model == testy) / length(predicted_model)))
```
Quan no hi ha més de vint classes, el rendiment en el subconjunt d'entrenament s'analitza mitjançant una matriu de confusió que identifica els tipus d'errors comesos. La matriu de confusió és la mesura típica per expressar la qualitat de les classes obtingudes en un model.
```{r}
# Matriu de confusió
mat_conf<-table(testy,Predicted=predicted_model)
mat_conf
```
```{r}
# Altra forma de calcular el percentatge de registres correctament classificats
porcentaje_correct<-100 * sum(diag(mat_conf)) / sum(mat_conf)
print(sprintf("El %% de registres correctament classificats és: %.4f %%",porcentaje_correct))

```
A més tenim el paquet gmodels per obtenir informació més completa:
```{r}
if(!require(gmodels)){
    install.packages('gmodels', repos='http://cran.us.r-project.org')
    library(gmodels)
}
```
```{r}
CrossTable(testy, predicted_model,prop.chisq  = FALSE, prop.c = FALSE, prop.r =FALSE,dnn = c('Reality', 'Prediction'))
```

******
# Exercicis
******

## Exercici 1:  
Contextualitzeu els exemples de les següents preguntes respecte al projecte que heu definit a la PAC1. Si ho desitgeu, podeu redefinir o canviar apartats del projecte.

Creieu que els arbres de decisió són el mètode més adequat per aconseguir els objectius que us havíeu proposat? Justifiqueu la resposta tot raonant-la.

Com podria ser l'arbre resultant?

Podríeu donar, tres exemples de regles que es poguessin derivar de l'arbre de decisió del vostre projecte?


### Resposta 1:
> Escriu aquí la resposta a la pregunta

## Exercici 2:  
Repetiu l'exercici 2 amb algun altre conjunt de dades. Poden ser dades reals del vostre àmbit laboral o d'algun repositori de dades a Internet. Mireu per exemple: http://www.ics.uci.edu/~mlearn/MLSummary.html  o d`altres repositoris ja citats
Seguiu el guió proposat a la pregunta anterior. Podeu afegir nous punts com ampliació de la resposta (per exemple provar la validació creuada, el boosting, variar el prunning o provar una altra mena d'arbre...) Recordeu també que el cicle de vida dels projectes de mineria contempla retrocedir per tornar a generar el model amb dades modificades o paràmetres de l'algorisme variats si el resultat no és prou bo.



### Resposta 2:

El primero pas consistirà en carregar les dades

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Càrrega del joc de dades

```
